$(document).ready(function(){var e=!1,t=$("#search-accomodation"),a=null;function n(e){var t=e.room_types,a=e.measures,n=e.markets,i=e,s=1==i.active?"Enabled":"Disabled";$("#search-accomodation :input[name=hotel]").val(i.hotel.name),$("#search-accomodation :input[name=status]").val(s),$("#search-accomodation :input[name=period]").val(moment(i.valid_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(i.valid_to,"YYYY-MM-DD").format("DD.MM.YYYY")),$(".result-container").html(""),$(".measures-list").html(""),$.each(a,function(e,t){var n='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" name="row-selected" checked value="'+a[e].id+'"> '+a[e].name+"<span></span></label>";$(".measures-list").append(n)}),$("#market").empty(),$.each(n,function(e,t){var a='<option value="'+n[e].id+'"> '+n[e].name+"</option>";$("#market").append(a)}),o(n),$(".room-types-list").html(""),$.each(t,function(e,a){var n='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" name="room-selected" checked value="'+t[e].id+'"> '+t[e].name+"<span></span></label>";$(".room-types-list").append(n)}),$("input[name=from]").datepicker("destroy"),$("input[name=to]").datepicker("destroy"),$(".datepicker-from-container").html(""),$(".datepicker-to-container").html("");var c='<label>From</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="from"> </div></div>';$(".datepicker-from-container").append(c),c='<label>To</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="to"> </div></div>',$(".datepicker-to-container").append(c),$(".datepicker").datepicker({format:"MM yyyy",viewMode:"months",minViewMode:"months",autoclose:!0,orientation:"bottom"});var m=moment(i.valid_from,"YYYY-MM-DD"),l=moment(i.valid_to,"YYYY-MM-DD"),d=moment();if(d.isSameOrBefore(l)&&d.isSameOrAfter(m)){var p=moment(d).startOf("month"),u=moment(d).endOf("month");$("input[name=from]").datepicker("setDate",new Date(p)),$("input[name=to]").datepicker("setDate",new Date(u))}else if(d.isBefore(m)){p=moment(m).startOf("month"),u=moment(m).endOf("month");$("input[name=from]").datepicker("setDate",new Date(p)),$("input[name=to]").datepicker("setDate",new Date(u))}else if(d.isAfter(l)){p=moment(l).startOf("month"),u=moment(l).endOf("month");$("input[name=from]").datepicker("setDate",new Date(p)),$("input[name=to]").datepicker("setDate",new Date(u))}$("input[name=from]").datepicker("setStartDate",new Date(m)),$("input[name=from]").datepicker("setEndDate",new Date(l)),$("input[name=to]").datepicker("setStartDate",new Date(m)),$("input[name=to]").datepicker("setEndDate",new Date(l)),$("#modal-setting :input[name=setting-from]").datepicker("setStartDate",new Date(m)),$("#modal-setting :input[name=setting-from]").datepicker("setEndDate",new Date(l)),$("#modal-setting :input[name=setting-to]").datepicker("setStartDate",new Date(m)),$("#modal-setting :input[name=setting-to]").datepicker("setEndDate",new Date(l)),$(".measures-container").html("");for(var f=0;f<i.measures.length;f++){c='<div class="row"><div class="col-md-12"><div class="col-md-5 col-sm-5 col-xs-5"><div class="form-group"><label>'+i.measures[f].name+'</label><input type="text" class="form-control measure-input" name="'+i.measures[f].code+'" readonly></div></div>';"cost"==i.measures[f].code?c+='<div class="col-md-5 col-sm-5 col-xs-5"><div class="mt-checkbox-inline"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15 margin-right-40"> Set<input type="checkbox" value="1" name="set-'+i.measures[f].code+'" data-set="'+i.measures[f].code+'" data-measure-id="'+i.measures[f].id+'" /><span></span></label><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15 margin-right-40"> Unset<input type="checkbox" value="0" name="unset-cost" /><span></span></label></div></div>':c+='<div class="col-md-5 col-sm-5 col-xs-5"><div class="mt-checkbox-inline"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15 margin-right-40"> Set<input type="checkbox" value="" name="set-'+i.measures[f].code+'" data-set="'+i.measures[f].code+'" data-measure-id="'+i.measures[f].id+'" /><span></span></label></div></div>',c+="</div></div>",$(".measures-container").append(c),$('input[name="set-'+i.measures[f].code+'"]').change(function(){var e=$(this).attr("data-set");$(this).is(":checked")?($("input[name="+e+"]").prop("readonly",""),$(this).val($(this).attr("data-measure-id"))):($(this).val("0"),$("input[name="+e+"]").prop("readonly",!0))})}$('input[name="unset-cost"]').change(function(){$(this).is(":checked")?($(".measure-input").prop("readonly",!0),$(".measure-input").val(""),$("input[name^=set-]").prop("checked",""),$("input[name^=set-]").attr("onclick","return false;"),r.validate(),$('input[name="cost"]').rules("remove","required")):($(".measure-input").prop("readonly",""),$("input[name^=set-]").attr("onclick",""),r.validate(),$('input[name="cost"]').rules("add","required"))})}function o(e){$("#price-rate").empty(),$(".import").remove(),$("#market option:not(:selected)").each(function(e){var t='<option value="'+$(this).val()+'"> '+$(this).text()+"</option>";$("#price-rate").append(t)}),e.length>1&&($(".room-name-header").append('<a class="btn btn-circle btn-icon-only btn-default btn-outline import hide-import" style="margin-left: 10px; margin-bottom: 7px;" href="javascript:;"><i class="fa fa-arrow-down"></i></a>'),$(".import").on("click",function(e){e.preventDefault(),$(this).hasClass("show-import")?($(".set-price-container").css("display","block"),$(".import-cost-container").css("display","none"),r.validate(),$('input[name="cost"]').rules("add","required"),$(this).removeClass("show-import"),$(this).addClass("hide-import"),$("input[name=import-cost]").val("")):($(".set-price-container").css("display","none"),$(".import-cost-container").css("display","block"),r.validate(),$('input[name="cost"]').rules("remove","required"),$(this).addClass("show-import"),$(this).removeClass("hide-import"),$("input[name=import-cost]").val("1"))}))}$(".date-picker").datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"dd.mm.yyyy",orientation:"bottom"}),$("#search-accomodation :input[name=contract]").select2({width:"off",ajax:{url:routeSearch,type:"POST",dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return{results:e}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:function(e){return e.loading?e.text:"<div class=''><div class=''>"+e.name+"</div></div>"},templateSelection:function(e){return e.name}}),$("#search-accomodation :input[name=contract]").on("select2:select select2:unselect",function(e){var t=e.params.data;if(t.selected){a=t,n(t);var o=window.location.href;if(o.indexOf("?")>0){var r=o.substring(0,o.indexOf("?"));window.history.replaceState({},document.title,r)}}}),$.ajax({url:routeContract,type:"POST",data:{contractId:contractId},beforeSend:function(){App.showMask(!0,t)},complete:function(e,o){if(App.showMask(!1,t),"200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var r=JSON.parse(e.responseText);null==(a=r.data)?toastr.warning(r.message,"Warning"):($("#search-accomodation :input[name=contract]").next().find(".select2-selection__rendered").html(a.name+'<span class="select2-selection__placeholder"></span>'),n(a),$(".filter-content").show())}}}),$(".btn-search-submit").on("click",function(e){if(e.preventDefault(),null==a)toastr.error("Invalid contract.","Error");else{var n=moment($("input[name=from]").datepicker("getDate")).format("DD.MM.YYYY"),i=moment($("input[name=to]").datepicker("getDate")).format("DD.MM.YYYY"),s=$("#market").val(),c=[];$('[name="room-selected"]:checked').each(function(){c.push($(this).val())});var m=[];$('[name="row-selected"]:checked').each(function(){m.push($(this).val())}),$.ajax({url:routeData,type:"POST",data:{id:a.id,from:n,to:i,market:s,rooms:JSON.stringify(c),rows:JSON.stringify(m)},beforeSend:function(){App.showMask(!0,t)},complete:function(e,n){if(App.showMask(!1,t),"200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var i=$.parseJSON(e.responseText);if("success"==i.status){var s=i.table;$(".result-container").html(""),$(".result-container").append(s),i.from,i.to,c=a,$(".item-setting").on("click",function(){r.validate(),$('input[name="cost"]').rules("add","required"),r.validate().resetForm(),r[0].reset();var e=$(this).parents("table").find("th:first").html();$("#modal-setting .room-name-header").html(e);var t=$(this).attr("data-date");$("#modal-setting :input[name=setting-from]").datepicker("setDate",new Date(moment(t,"YYYY-MM-DD"))),$("#modal-setting :input[name=setting-to]").datepicker("setDate",new Date(moment(t,"YYYY-MM-DD"))),$("#modal-setting .measures-container :input").prop("readonly",!0),$("#modal-setting .measures-container :input").prop("checked","");var a=$(this).parents("tr").find("td:first").attr("data-measure-code");$("#modal-setting :input[name="+a+"]").prop("readonly",!1),$("#modal-setting :input[data-set="+a+"]").prop("checked","checked"),$("#modal-setting :input[data-set="+a+"]").val($("#modal-setting :input[data-set="+a+"]").attr("data-measure-id")),$("#modal-setting :input[name=contract-id]").val(c.id),$("#modal-setting :input[name=room-type-id]").val($(this).attr("data-room-type-id")),$("#modal-setting :input[name=market-id]").val($(this).attr("data-market-id"));for(var n=0;n<c.measures.length;n++){var t=$(this).attr("data-date"),i=c.measures[n].id,s=$(this).parents("table").find('td[data-date="'+t+'"][data-measure-id="'+i+'"]').html();$('#modal-setting :input[name="'+c.measures[n].code+'"]').val(s)}$("#modal-setting .range-optional").each(function(){$(this).remove()}),o(c.markets),$(".set-price-container").css("display","block"),$(".import-cost-container").css("display","none"),$("input[name=import-cost]").val(""),$("#modal-setting").modal("show")})}else toastr.error(i.message,"Error")}var c}})}});var r=$("#form-setting");r.validate({errorElement:"span",errorClass:"help-block help-block-error",focusInvalid:!1,ignore:"",rules:{cost:{required:!0},"setting-from":{required:!0},"setting-to":{required:!0}},errorPlacement:function(e,t){t.parents(".mt-radio-list").size()>0||t.parents(".mt-checkbox-list").size()>0?(t.parents(".mt-radio-list").size()>0&&e.appendTo(t.parents(".mt-radio-list")[0]),t.parents(".mt-checkbox-list").size()>0&&e.appendTo(t.parents(".mt-checkbox-list")[0])):t.parents(".mt-radio-inline").size()>0||t.parents(".mt-checkbox-inline").size()>0?(t.parents(".mt-radio-inline").size()>0&&e.appendTo(t.parents(".mt-radio-inline")[0]),t.parents(".mt-checkbox-inline").size()>0&&e.appendTo(t.parents(".mt-checkbox-inline")[0])):t.parent(".input-group").size()>0?e.insertAfter(t.parent(".input-group")):t.attr("data-error-container")?e.appendTo(t.attr("data-error-container")):e.insertAfter(t)},invalidHandler:function(e,t){toastr.error("Please check the entry fields.","Error")},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},unhighlight:function(e){$(e).closest(".form-group").removeClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error")},submitHandler:function(t){var a=$(t).find("button[type=submit]:focus").attr("data"),n=new FormData(r[0]),o=$("#market").val(),i=[];$("#modal-setting .range").each(function(){var e={from:$(this).find('input[name^="setting-from"]').val(),to:$(this).find('input[name^="setting-to"]').val()};i.push(e)}),n.append("ranges",JSON.stringify(i)),n.append("market",o),$.ajax({url:routeSave,type:"POST",data:n,contentType:!1,processData:!1,beforeSend:function(){App.showMask(!0,r)},complete:function(n,o){if(App.showMask(!1,r),"200"!=n.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var i=$.parseJSON(n.responseText);"success"==i.status?(toastr.success(i.message,"Success"),r[0].reset(),e=!0,"accept"==a&&$(t).find("button.cancel-form").click()):toastr.error(i.message,"Error")}}})}}),$(".add-row").on("click",function(e){e.preventDefault();var t=$.now(),n='<div class="range range-optional" data="'+t+'"><div class="col-md-5 col-sm-5 col-xs-5"><div class="form-group"><label>From</label><div class="input-icon left"><i class="fa fa-calendar"></i><input type="text" class="form-control date-picker" name="setting-from-'+t+'"></div></div></div><div class="col-md-5 col-sm-5 col-xs-5"><div class="form-group"><label>To</label><div class="input-icon left"><i class="fa fa-calendar"></i><input type="text" class="form-control date-picker" name="setting-to-'+t+'"></div></div></div><div class="col-md-2 col-sm-2 col-xs-2"><div class="form-group"><a class="btn red btn-outline delete-row" href="#" data="'+t+'"><i class="fa fa-trash"></i></a></div></div></div>';$(".range-container").append(n),$('input[name="setting-from-'+t+'"]').datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"dd.mm.yyyy",orientation:"bottom"}),$('input[name="setting-to-'+t+'"]').datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"dd.mm.yyyy",orientation:"bottom"});var o=moment(a.valid_from,"YYYY-MM-DD"),i=moment(a.valid_to,"YYYY-MM-DD");$('input[name="setting-from-'+t+'"]').datepicker("setStartDate",new Date(o)),$('input[name="setting-from-'+t+'"]').datepicker("setEndDate",new Date(i)),$('input[name="setting-to-'+t+'"]').datepicker("setStartDate",new Date(o)),$('input[name="setting-to-'+t+'"]').datepicker("setEndDate",new Date(i)),r.validate(),$('input[name="setting-from-'+t+'"]').rules("add","required"),$('input[name="setting-to-'+t+'"]').rules("add","required"),$('.delete-row[data="'+t+'"]').on("click",function(e){$('.range[data="'+t+'"]').remove(),e.preventDefault()})}),$(".cancel-form").on("click",function(t){e&&($(".btn-search-submit").click(),e=!1)})});