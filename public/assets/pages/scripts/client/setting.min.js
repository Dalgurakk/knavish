$(document).ready(function(){var c=$("#search-accomodation"),r=null,d=!1;function i(){$.ajax({url:routeContract,type:"POST",data:{contractId:contractId},beforeSend:function(){App.showMask(!0,c)},complete:function(e,t){if(App.showMask(!1,c),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=JSON.parse(e.responseText);null==(r=a.data)?toastr.warning(a.message,"Warning"):($("#search-accomodation :input[name=contract]").next().find(".select2-selection__rendered").html(r.name+'<span class="select2-selection__placeholder"></span>'),n(r),$(".filter-content").show())}}})}function n(e){var o=e.hotel_contract.room_types,i=e.hotel_contract.board_types,n=e.hotel_contract.measures,t=e.hotel_contract,a=e.client,s=1==t.active?"Enabled":"Disabled";$("#search-accomodation :input[name=hotel]").val(t.hotel.name),$("#search-accomodation :input[name=hotel-chain]").val(t.hotel.hotel_chain.name),$("#search-accomodation :input[name=status]").val(s),$("#search-accomodation :input[name=client]").val(a.name),$("#search-accomodation :input[name=period]").val(moment(t.valid_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(t.valid_to,"YYYY-MM-DD").format("DD.MM.YYYY")),$(".result-container").html(""),$(".measures-list").html(""),$.each(n,function(e,t){var a='<div class="row"><div class="col-md-5"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-selected" checked value="'+n[e].id+'"> '+n[e].name+"<span></span></label></div>";"price"!=n[e].code&&"allotment"!=n[e].code||(a+='<div class="col-md-7"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-expanded" value="'+n[e].code+'"> Expand '+n[e].name+"<span></span></label></div>"),a+="</div>",$(".measures-list").append(a)}),$("#board-type").empty(),$.each(i,function(e,t){var a='<option value="'+i[e].id+'"> '+i[e].code+": "+i[e].name+"</option>";$("#board-type").append(a)}),$(".room-types-list").html(""),$.each(o,function(e,t){var a='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="room-selected" checked value="'+o[e].id+'"> '+o[e].code+": "+o[e].name+"<span></span></label>";$(".room-types-list").append(a)}),$("input[name=from]").datepicker("destroy"),$("input[name=to]").datepicker("destroy"),$(".datepicker-from-container").html(""),$(".datepicker-to-container").html("");var c='<label>From</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="from"> </div></div>';$(".datepicker-from-container").append(c),c='<label>To</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="to"> </div></div>',$(".datepicker-to-container").append(c),$(".datepicker").datepicker({format:"MM yyyy",viewMode:"months",minViewMode:"months",autoclose:!0,orientation:"bottom"});var r=moment(t.valid_from,"YYYY-MM-DD"),d=moment(t.valid_to,"YYYY-MM-DD"),l=moment(),m=l,p=l;l.isSameOrBefore(d)&&l.isSameOrAfter(r)?(m=moment(l).startOf("month"),p=moment(l).endOf("month")):l.isBefore(r)?(m=moment(r).startOf("month"),p=moment(r).endOf("month")):l.isAfter(d)&&(m=moment(d).startOf("month"),p=moment(d).endOf("month"),console.log(d.format("DD.MM.YYYY"))),m.isBefore(r)&&(m=r),p.isAfter(d)&&(p=d),$("input[name=from]").datepicker("setStartDate",new Date(r)),$("input[name=from]").datepicker("setEndDate",new Date(d)),$("input[name=to]").datepicker("setStartDate",new Date(r)),$("input[name=to]").datepicker("setEndDate",new Date(d)),$("input[name=from]").datepicker("setDate",new Date(m)),$("input[name=to]").datepicker("setDate",new Date(p)),$(".measures-container").html("");for(var v=0;v<t.measures.length;v++){c='<div class="row"><div class="col-md-12"><div class="col-md-6 col-sm-6 col-xs-6"><div class="form-group"><label>'+t.measures[v].name+'</label><input type="text" class="form-control" name="'+t.measures[v].code+'" readonly></div></div><div class="col-md-6 col-sm-6 col-xs-6"><div class="mt-checkbox-list"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15"> Set<input type="checkbox" value="" name="set-'+t.measures[v].code+'" data-set="'+t.measures[v].code+'" data-measure-id="'+t.measures[v].id+'" /><span></span></label></div></div></div></div>';$(".measures-container").append(c),$('input[name="set-'+t.measures[v].code+'"]').change(function(){var e=$(this).attr("data-set");$(this).is(":checked")?($("input[name="+e+"]").prop("readonly",""),$(this).val($(this).attr("data-measure-id"))):($(this).val("0"),$("input[name="+e+"]").prop("readonly",!0))})}}i(),$("#search-accomodation :input[name=contract]").select2({width:"off",ajax:{url:routeSearch,type:"POST",dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return{results:e}},complete:function(e,t){"419"==e.status&&location.reload(!0)},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:function(e){return e.loading?e.text:"<div class=''><div class=''>"+e.name+"</div></div>"},templateSelection:function(e){return e.name}}),$("#search-accomodation :input[name=contract]").on("select2:select select2:unselect",function(e){var t=e.params.data;if(t.selected){d=!1,contractId=t.id,i(),n(r);var a=window.location.href;if(0<a.indexOf("?")){var o=a.substring(0,a.indexOf("?"));window.history.replaceState({},document.title,o)}}}),$("#board-type").change(function(){d&&$(".btn-search-submit").click()}),$(".btn-search-submit").on("click",function(e){if(e.preventDefault(),null==r)toastr.error("Invalid contract.","Error");else{var t=moment($("input[name=from]").datepicker("getDate")).format("DD.MM.YYYY"),a=moment($("input[name=to]").datepicker("getDate")).format("DD.MM.YYYY"),o=$("#board-type").val(),i=[];$(".room-selected:checked").each(function(){i.push($(this).val())});var n=[];$(".row-selected:checked").each(function(){n.push($(this).val())}),$.ajax({url:routeData,type:"POST",data:{id:r.id,from:t,to:a,boardType:o,rooms:JSON.stringify(i),rows:JSON.stringify(n)},beforeSend:function(){App.showMask(!0,c)},complete:function(e,t){if(App.showMask(!1,c),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{d=!0;var a=$.parseJSON(e.responseText);if("success"==a.status){var o=a.table;$(".result-container").html(""),$(".result-container").html('<div class="note note-info"><p>Pricing are all per person per night.</p></div>'),$(".result-container").append(o),a.from,a.to,k=r,$(".item-setting").on("click",function(){if($(this).hasClass("complement")){var e=$(this).attr("data-measure-code");if("offer"==e){$(this).attr("data");var t=JSON.parse("["+$(this).attr("data")+"]");if(!(0<t.length))return!1;var a=k.hotel_contract.offers;$("#modal-offers .offers-container").html("");for(var o="",i=0;i<t.length;i++)for(var n=0;n<a.length;n++)if(t[i]==a[n].id){for(var s=a[n].rooms,c="",r=0;r<s.length;r++)c+=0==r?s[r].room_type.code+": "+s[r].room_type.name:", "+s[r].room_type.code+": "+s[r].room_type.name;for(var d=a[n].boards,l="",r=0;r<d.length;r++)l+=0==r?d[r].board_type.code+": "+d[r].board_type.name:", "+d[r].board_type.code+": "+d[r].board_type.name;for(var m=a[n].ranges,p="",r=0;r<m.length;r++){var v=moment(m[r].from,"YYYY-MM-DD").format("DD.MM.YYYY"),f=moment(m[r].to,"YYYY-MM-DD").format("DD.MM.YYYY");p+=0==r?v==f?v:v+" - "+f:v==f?", "+v:", "+v+" - "+f}var h="",u="",Y=$.now();if("early_booking"==a[n].offer_type.code){if(h='<div class="actions"><a href="javascript:;" class="btn btn-default btn-sm btn-offer-details" data="'+Y+'" style="margin-right: 5px;"><i class="fa fa-binoculars"></i> Details </a></div>',null!=a[n].discount&&(u+='<div class="row static-info"><div class="col-md-3 name"> Discount: </div>',1==a[n].discount_type?u+='<div class="col-md-9 value"> '+a[n].discount+"%</div></div>":u+='<div class="col-md-9 value">$'+a[n].discount+" </div></div>"),null!=a[n].booking_type){var b="";1==a[n].booking_type?b=a[n].booking_date_from==a[n].booking_date_to?moment(a[n].booking_date_from,"YYYY-MM-DD").format("DD.MM.YYYY"):moment(a[n].booking_date_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(a[n].booking_date_to,"YYYY-MM-DD").format("DD.MM.YYYY"):2==a[n].booking_type&&(b=a[n].days_prior_from==a[n].days_prior_to?a[n].days_prior_from+" days prior to the check-in":a[n].days_prior_from+" - "+a[n].days_prior_to+" days prior to the check-in"),u+='<div class="row static-info"><div class="col-md-3 name"> Booking Date: </div><div class="col-md-9 value"> '+b+" </div></div>"}null!=a[n].payment_date&&(u+='<div class="row static-info"><div class="col-md-3 name"> Payment Date: </div><div class="col-md-9 value"> '+moment(a[n].payment_date,"YYYY-MM-DD").format("DD.MM.YYYY")+' </div></div><div class="row static-info"><div class="col-md-3 name"> Percentage Due: </div><div class="col-md-9 value"> '+a[n].percentage_due+"%</div></div>"),null!=a[n].minimum_stay&&(u+='<div class="row static-info"><div class="col-md-3 name"> Minimum Stay: </div><div class="col-md-9 value"> '+a[n].minimum_stay+" </div></div>");var y=1==a[n].non_refundable?"Yes":"No";u+='<div class="row static-info"><div class="col-md-3 name"> Non Refundable: </div><div class="col-md-9 value"> '+y+" </div></div>"}o+='<div class="col-md-12"><div class="portlet box blue"><div class="portlet-title"><div class="caption"><i class="fa fa-cogs"></i>'+a[n].name+'</div><div class="tools"><a href="javascript:;" class="collapse"> </a></div>'+h+'</div><div class="portlet-body"><div class="row static-info"><div class="col-md-3 name"> Denomination: </div><div class="col-md-9 value"> '+a[n].name+'</div></div><div class="row static-info"><div class="col-md-3 name"> Type: </div><div class="col-md-9 value"> '+a[n].offer_type.name+' </div></div><div class="row static-info"><div class="col-md-3 name"> Ranges: </div><div class="col-md-9 value"> '+p+' </div></div><div class="row static-info"><div class="col-md-3 name"> Board Types: </div><div class="col-md-9 value"> '+l+' </div></div><div class="row static-info"><div class="col-md-3 name"> Rooms: </div><div class="col-md-9 value"> '+c+' </div></div><div class="offer-detail-container hidden" data="'+Y+'">'+u+"</div></div></div></div>";break}$("#modal-offers .offers-container").append(o),$(".btn-offer-details").on("click",function(){var e=$(this).attr("data");$('.offer-detail-container[data="'+e+'"]').hasClass("hidden")?$('.offer-detail-container[data="'+e+'"]').removeClass("hidden"):$('.offer-detail-container[data="'+e+'"]').addClass("hidden")}),$("#modal-offers").modal("show")}}}),$(".measure-detail").on("click",function(){var e=$(this).attr("data");$(this).hasClass("closed")?($(this).removeClass("closed"),$(this).addClass("opened"),$(this).html("-"),$('tr[data-parent="'+e+'"]').removeClass("hidden")):($(this).removeClass("opened"),$(this).addClass("closed"),$(this).html("+"),$('tr[data-parent="'+e+'"]').addClass("hidden"))}),$(".row-expanded:checked").each(function(){$('.measure-detail[data-measure="'+$(this).val()+'"]').click()});var s=a.offers;r.hotel_contract.offers=s,$(".complement").each(function(){var e=$(this).attr("data-measure-code"),t=$(this).attr("data");if("offer"==e&&""!=t){for(var a=JSON.parse("["+t+"]"),o='<table class="table table-striped table-complement" width="100%" cellspacing="0" style="margin-bottom: 0"><thead><tr><th> # </th><th> Denomination </th><th> Type </th></thead><tbody>',i=0;i<a.length;i++)for(var n=0;n<s.length;n++)if(a[i]==s[n].id){o+="<tr><td>"+(i+1)+"</td><td>"+s[n].name+"</td><td>"+s[n].offer_type.name+"</td></tr>";break}o+="</tbody></table>",$(this).popover({trigger:"hover",container:"body",placement:"top",title:"Offers",content:o,delay:{show:500,hide:100},html:!0,template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title porlet-title-setting"></h3><div class="popover-content" style="padding: 5px;"></div></div>'})}})}else toastr.error(a.message,"Error")}var k}})}}),$(".check-all-rooms").on("click",function(e){e.preventDefault(),"check"==$(this).attr("data")?($(this).attr("data","uncheck"),$(".room-selected").each(function(){$(this).prop("checked",!1)})):($(this).attr("data","check"),$(".room-selected").each(function(){$(this).prop("checked",!0)}))})});