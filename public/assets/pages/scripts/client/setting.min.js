$(document).ready(function(){var s=$("#search-accomodation"),i=null,l=!1;function n(e){var o=e.hotel_contract.room_types,n=e.hotel_contract.board_types,c=e.hotel_contract.measures,t=e.hotel_contract,a=e.client,r=1==t.active?"Enabled":"Disabled";$("#search-accomodation :input[name=hotel]").val(t.hotel.name),$("#search-accomodation :input[name=hotel-chain]").val(t.hotel.hotel_chain.name),$("#search-accomodation :input[name=status]").val(r),$("#search-accomodation :input[name=client]").val(a.name),$("#search-accomodation :input[name=period]").val(moment(t.valid_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(t.valid_to,"YYYY-MM-DD").format("DD.MM.YYYY")),$(".result-container").html(""),$(".measures-list").html(""),$.each(c,function(e,t){var a='<div class="row"><div class="col-md-5"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-selected" checked value="'+c[e].id+'"> '+c[e].name+"<span></span></label></div>";"price"!=c[e].code&&"allotment"!=c[e].code||(a+='<div class="col-md-7"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-expanded" value="'+c[e].code+'"> Expand '+c[e].name+"<span></span></label></div>"),a+="</div>",$(".measures-list").append(a)}),$("#board-type").empty(),$.each(n,function(e,t){var a='<option value="'+n[e].id+'"> '+n[e].code+": "+n[e].name+"</option>";$("#board-type").append(a)}),$(".room-types-list").html(""),$.each(o,function(e,t){var a='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="room-selected" checked value="'+o[e].id+'"> '+o[e].code+": "+o[e].name+"<span></span></label>";$(".room-types-list").append(a)}),$("input[name=from]").datepicker("destroy"),$("input[name=to]").datepicker("destroy"),$(".datepicker-from-container").html(""),$(".datepicker-to-container").html("");var s='<label>From</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="from"> </div></div>';$(".datepicker-from-container").append(s),s='<label>To</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="to"> </div></div>',$(".datepicker-to-container").append(s),$(".datepicker").datepicker({format:"MM yyyy",viewMode:"months",minViewMode:"months",autoclose:!0,orientation:"bottom"});var i=moment(t.valid_from,"YYYY-MM-DD"),l=moment(t.valid_to,"YYYY-MM-DD"),d=moment(),m=d,p=d;d.isSameOrBefore(l)&&d.isSameOrAfter(i)?(m=moment(d).startOf("month"),p=moment(d).endOf("month")):d.isBefore(i)?(m=moment(i).startOf("month"),p=moment(i).endOf("month")):d.isAfter(l)&&(m=moment(l).startOf("month"),p=moment(l).endOf("month"),console.log(l.format("DD.MM.YYYY"))),m.isBefore(i)&&(m=i),p.isAfter(l)&&(p=l),$("input[name=from]").datepicker("setStartDate",new Date(i)),$("input[name=from]").datepicker("setEndDate",new Date(l)),$("input[name=to]").datepicker("setStartDate",new Date(i)),$("input[name=to]").datepicker("setEndDate",new Date(l)),$("input[name=from]").datepicker("setDate",new Date(m)),$("input[name=to]").datepicker("setDate",new Date(p)),$(".measures-container").html("");for(var h=0;h<t.measures.length;h++){s='<div class="row"><div class="col-md-12"><div class="col-md-6 col-sm-6 col-xs-6"><div class="form-group"><label>'+t.measures[h].name+'</label><input type="text" class="form-control" name="'+t.measures[h].code+'" readonly></div></div><div class="col-md-6 col-sm-6 col-xs-6"><div class="mt-checkbox-list"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15"> Set<input type="checkbox" value="" name="set-'+t.measures[h].code+'" data-set="'+t.measures[h].code+'" data-measure-id="'+t.measures[h].id+'" /><span></span></label></div></div></div></div>';$(".measures-container").append(s),$('input[name="set-'+t.measures[h].code+'"]').change(function(){var e=$(this).attr("data-set");$(this).is(":checked")?($("input[name="+e+"]").prop("readonly",""),$(this).val($(this).attr("data-measure-id"))):($(this).val("0"),$("input[name="+e+"]").prop("readonly",!0))})}}$("#search-accomodation :input[name=contract]").select2({width:"off",ajax:{url:routeSearch,type:"POST",dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return{results:e}},complete:function(e,t){"419"==e.status&&location.reload(!0)},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:function(e){return e.loading?e.text:"<div class=''><div class=''>"+e.name+"</div></div>"},templateSelection:function(e){return e.name}}),$("#search-accomodation :input[name=contract]").on("select2:select select2:unselect",function(e){var t=e.params.data;if(t.selected){l=!1,n(i=t);var a=window.location.href;if(0<a.indexOf("?")){var o=a.substring(0,a.indexOf("?"));window.history.replaceState({},document.title,o)}}}),$.ajax({url:routeContract,type:"POST",data:{contractId:contractId},beforeSend:function(){App.showMask(!0,s)},complete:function(e,t){if(App.showMask(!1,s),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=JSON.parse(e.responseText);null==(i=a.data)?toastr.warning(a.message,"Warning"):($("#search-accomodation :input[name=contract]").next().find(".select2-selection__rendered").html(i.name+'<span class="select2-selection__placeholder"></span>'),n(i),$(".filter-content").show())}}}),$("#board-type").change(function(){l&&$(".btn-search-submit").click()}),$(".btn-search-submit").on("click",function(e){if(e.preventDefault(),null==i)toastr.error("Invalid contract.","Error");else{var t=moment($("input[name=from]").datepicker("getDate")).format("DD.MM.YYYY"),a=moment($("input[name=to]").datepicker("getDate")).format("DD.MM.YYYY"),o=$("#board-type").val(),n=[];$(".room-selected:checked").each(function(){n.push($(this).val())});var c=[];$(".row-selected:checked").each(function(){c.push($(this).val())}),$.ajax({url:routeData,type:"POST",data:{id:i.id,from:t,to:a,boardType:o,rooms:JSON.stringify(n),rows:JSON.stringify(c)},beforeSend:function(){App.showMask(!0,s)},complete:function(e,t){if(App.showMask(!1,s),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{l=!0;var a=$.parseJSON(e.responseText);if("success"==a.status){var o=a.table;$(".result-container").html(""),$(".result-container").html('<div class="note note-info"><p>Pricing are all per person per night.</p></div>'),$(".result-container").append(o),a.from,a.to,$(".measure-detail").on("click",function(){var e=$(this).attr("data");$(this).hasClass("closed")?($(this).removeClass("closed"),$(this).addClass("opened"),$(this).html("-"),$('tr[data-parent="'+e+'"]').removeClass("hidden")):($(this).removeClass("opened"),$(this).addClass("closed"),$(this).html("+"),$('tr[data-parent="'+e+'"]').addClass("hidden"))}),$(".row-expanded:checked").each(function(){$('.measure-detail[data-measure="'+$(this).val()+'"]').click()});var r=i.hotel_contract.offers;$(".complement").each(function(){var e=$(this).attr("data-measure-code"),t=$(this).attr("data");if("offer"==e&&""!=t){for(var a=JSON.parse("["+t+"]"),o='<table class="table table-striped table-complement" width="100%" cellspacing="0" style="margin-bottom: 0"><thead><tr><th> # </th><th> Denomination </th><th> Type </th></thead><tbody>',n=0;n<a.length;n++)for(var c=0;c<r.length;c++)if(a[n]==r[c].id){o+="<tr><td>"+(n+1)+"</td><td>"+r[c].name+"</td><td>"+r[c].offer_type.name+"</td></tr>";break}o+="</tbody></table>",$(this).popover({trigger:"hover",container:"body",placement:"top",title:"Offers",content:o,delay:{show:500,hide:100},html:!0,template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title porlet-title-setting"></h3><div class="popover-content" style="padding: 5px;"></div></div>'})}})}else toastr.error(a.message,"Error")}}})}}),$(".check-all-rooms").on("click",function(e){e.preventDefault(),"check"==$(this).attr("data")?($(this).attr("data","uncheck"),$(".room-selected").each(function(){$(this).prop("checked",!1)})):($(this).attr("data","check"),$(".room-selected").each(function(){$(this).prop("checked",!0)}))})});