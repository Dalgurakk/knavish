$(document).ready(function(){var r=$("#search-accomodation"),s=null;function o(e){var n=e.hotel_contract.room_types,o=e.hotel_contract.measures,t=e.hotel_contract,a=e.client,r=1==t.active?"Enabled":"Disabled";$("#search-accomodation :input[name=hotel]").val(t.hotel.name),$("#search-accomodation :input[name=status]").val(r),$("#search-accomodation :input[name=client]").val(a.name),$("#search-accomodation :input[name=period]").val(moment(t.valid_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(t.valid_to,"YYYY-MM-DD").format("DD.MM.YYYY")),$(".result-container").html(""),$(".measures-list").html(""),$.each(o,function(e,t){var a='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" name="row-selected" checked value="'+o[e].id+'"> '+o[e].name+"<span></span></label>";$(".measures-list").append(a)}),$(".room-types-list").html(""),$.each(n,function(e,t){var a='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" name="room-selected" checked value="'+n[e].id+'"> '+n[e].name+"<span></span></label>";$(".room-types-list").append(a)}),$("input[name=from]").datepicker("destroy"),$("input[name=to]").datepicker("destroy"),$(".datepicker-from-container").html(""),$(".datepicker-to-container").html("");var s='<label>From</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="from"> </div></div>';$(".datepicker-from-container").append(s),s='<label>To</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="to"> </div></div>',$(".datepicker-to-container").append(s),$(".datepicker").datepicker({format:"MM yyyy",viewMode:"months",minViewMode:"months",autoclose:!0,orientation:"bottom"});var c=moment(t.valid_from,"YYYY-MM-DD"),i=moment(t.valid_to,"YYYY-MM-DD"),m=moment(),l=m,d=m;m.isSameOrBefore(i)&&m.isSameOrAfter(c)?(l=moment(m).startOf("month"),d=moment(m).endOf("month")):m.isBefore(c)?(l=moment(c).startOf("month"),d=moment(c).endOf("month")):m.isAfter(i)&&(l=moment(i).startOf("month"),d=moment(i).endOf("month"),console.log(i.format("DD.MM.YYYY"))),l.isBefore(c)&&(l=c),d.isAfter(i)&&(d=i),$("input[name=from]").datepicker("setStartDate",new Date(c)),$("input[name=from]").datepicker("setEndDate",new Date(i)),$("input[name=to]").datepicker("setStartDate",new Date(c)),$("input[name=to]").datepicker("setEndDate",new Date(i)),$("input[name=from]").datepicker("setDate",new Date(l)),$("input[name=to]").datepicker("setDate",new Date(d)),$(".measures-container").html("");for(var p=0;p<t.measures.length;p++){s='<div class="row"><div class="col-md-12"><div class="col-md-6 col-sm-6 col-xs-6"><div class="form-group"><label>'+t.measures[p].name+'</label><input type="text" class="form-control" name="'+t.measures[p].code+'" readonly></div></div><div class="col-md-6 col-sm-6 col-xs-6"><div class="mt-checkbox-list"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15"> Set<input type="checkbox" value="" name="set-'+t.measures[p].code+'" data-set="'+t.measures[p].code+'" data-measure-id="'+t.measures[p].id+'" /><span></span></label></div></div></div></div>';$(".measures-container").append(s),$('input[name="set-'+t.measures[p].code+'"]').change(function(){var e=$(this).attr("data-set");$(this).is(":checked")?($("input[name="+e+"]").prop("readonly",""),$(this).val($(this).attr("data-measure-id"))):($(this).val("0"),$("input[name="+e+"]").prop("readonly",!0))})}}$("#search-accomodation :input[name=contract]").select2({width:"off",ajax:{url:routeSearch,type:"POST",dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return{results:e}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:function(e){return e.loading?e.text:"<div class=''><div class=''>"+e.name+"</div></div>"},templateSelection:function(e){return e.name}}),$("#search-accomodation :input[name=contract]").on("select2:select select2:unselect",function(e){var t=e.params.data;if(t.selected){o(s=t);var a=window.location.href;if(0<a.indexOf("?")){var n=a.substring(0,a.indexOf("?"));window.history.replaceState({},document.title,n)}}}),$.ajax({url:routeClient,type:"POST",data:{contractId:contractId},beforeSend:function(){App.showMask(!0,r)},complete:function(e,t){if(App.showMask(!1,r),"200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=JSON.parse(e.responseText);null==(s=a.data)?toastr.warning(a.message,"Warning"):($("#search-accomodation :input[name=contract]").next().find(".select2-selection__rendered").html(s.name+'<span class="select2-selection__placeholder"></span>'),o(s),$(".filter-content").show())}}}),$(".btn-search-submit").on("click",function(e){if(e.preventDefault(),null==s)toastr.error("Invalid contract.","Error");else{var t=moment($("input[name=from]").datepicker("getDate")).format("DD.MM.YYYY"),a=moment($("input[name=to]").datepicker("getDate")).format("DD.MM.YYYY"),n=[];$('[name="room-selected"]:checked').each(function(){n.push($(this).val())});var o=[];$('[name="row-selected"]:checked').each(function(){o.push($(this).val())}),$.ajax({url:routeData,type:"POST",data:{id:s.id,from:t,to:a,rooms:JSON.stringify(n),rows:JSON.stringify(o)},beforeSend:function(){App.showMask(!0,r)},complete:function(e,t){if(App.showMask(!1,r),"200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=$.parseJSON(e.responseText);if("success"==a.status){var n=a.table;$(".result-container").html(""),$(".result-container").append(n),a.from,a.to,o=s,$(".item-setting").on("click",function(){$(this).parents("table").find("th:first").html();for(var e=$(this).attr("data-date"),t=($(this).parents("tr").find("td:first").attr("data-measure-code"),0);t<o.measures.length;t++){var e=$(this).attr("data-date"),a=o.measures[t].id;$(this).parents("table").find('td[data-date="'+e+'"][data-measure-id="'+a+'"]').html()}})}else toastr.error(a.message,"Error")}var o}})}})});