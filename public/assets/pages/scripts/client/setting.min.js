$(document).ready(function(){var c=$("#search-accomodation"),s=null;function n(e){var o=e.hotel_contract.room_types,n=e.hotel_contract.measures,t=e.hotel_contract,a=e.client,c=1==t.active?"Enabled":"Disabled";$("#search-accomodation :input[name=hotel]").val(t.hotel.name),$("#search-accomodation :input[name=status]").val(c),$("#search-accomodation :input[name=client]").val(a.name),$("#search-accomodation :input[name=period]").val(moment(t.valid_from,"YYYY-MM-DD").format("DD.MM.YYYY")+" - "+moment(t.valid_to,"YYYY-MM-DD").format("DD.MM.YYYY")),$(".result-container").html(""),$(".measures-list").html(""),$.each(n,function(e,t){var a='<div class="row"><div class="col-md-5"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-selected" checked value="'+n[e].id+'"> '+n[e].name+"<span></span></label></div>";"price"!=n[e].code&&"allotment"!=n[e].code||(a+='<div class="col-md-7"><label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="row-expanded" value="'+n[e].code+'"> Expand '+n[e].name+"<span></span></label></div>"),a+="</div>",$(".measures-list").append(a)}),$(".room-types-list").html(""),$.each(o,function(e,t){var a='<label class="mt-checkbox mt-checkbox-outline mt-checkbox-row"><input type="checkbox" class="room-selected" checked value="'+o[e].id+'"> '+o[e].code+": "+o[e].name+"<span></span></label>";$(".room-types-list").append(a)}),$("input[name=from]").datepicker("destroy"),$("input[name=to]").datepicker("destroy"),$(".datepicker-from-container").html(""),$(".datepicker-to-container").html("");var s='<label>From</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="from"> </div></div>';$(".datepicker-from-container").append(s),s='<label>To</label><div class="form-group"><div class="input-icon"><i class="fa fa-calendar"></i><input class="form-control datepicker" name="to"> </div></div>',$(".datepicker-to-container").append(s),$(".datepicker").datepicker({format:"MM yyyy",viewMode:"months",minViewMode:"months",autoclose:!0,orientation:"bottom"});var r=moment(t.valid_from,"YYYY-MM-DD"),i=moment(t.valid_to,"YYYY-MM-DD"),l=moment(),d=l,m=l;l.isSameOrBefore(i)&&l.isSameOrAfter(r)?(d=moment(l).startOf("month"),m=moment(l).endOf("month")):l.isBefore(r)?(d=moment(r).startOf("month"),m=moment(r).endOf("month")):l.isAfter(i)&&(d=moment(i).startOf("month"),m=moment(i).endOf("month"),console.log(i.format("DD.MM.YYYY"))),d.isBefore(r)&&(d=r),m.isAfter(i)&&(m=i),$("input[name=from]").datepicker("setStartDate",new Date(r)),$("input[name=from]").datepicker("setEndDate",new Date(i)),$("input[name=to]").datepicker("setStartDate",new Date(r)),$("input[name=to]").datepicker("setEndDate",new Date(i)),$("input[name=from]").datepicker("setDate",new Date(d)),$("input[name=to]").datepicker("setDate",new Date(m)),$(".measures-container").html("");for(var p=0;p<t.measures.length;p++){s='<div class="row"><div class="col-md-12"><div class="col-md-6 col-sm-6 col-xs-6"><div class="form-group"><label>'+t.measures[p].name+'</label><input type="text" class="form-control" name="'+t.measures[p].code+'" readonly></div></div><div class="col-md-6 col-sm-6 col-xs-6"><div class="mt-checkbox-list"><label class="mt-checkbox mt-checkbox-outline no-margin-bottom margin-top-15"> Set<input type="checkbox" value="" name="set-'+t.measures[p].code+'" data-set="'+t.measures[p].code+'" data-measure-id="'+t.measures[p].id+'" /><span></span></label></div></div></div></div>';$(".measures-container").append(s),$('input[name="set-'+t.measures[p].code+'"]').change(function(){var e=$(this).attr("data-set");$(this).is(":checked")?($("input[name="+e+"]").prop("readonly",""),$(this).val($(this).attr("data-measure-id"))):($(this).val("0"),$("input[name="+e+"]").prop("readonly",!0))})}}$("#search-accomodation :input[name=contract]").select2({width:"off",ajax:{url:routeSearch,type:"POST",dataType:"json",delay:250,data:function(e){return{q:e.term,page:e.page}},processResults:function(e,t){return{results:e}},complete:function(e,t){"419"==e.status&&location.reload(!0)},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:function(e){return e.loading?e.text:"<div class=''><div class=''>"+e.name+"</div></div>"},templateSelection:function(e){return e.name}}),$("#search-accomodation :input[name=contract]").on("select2:select select2:unselect",function(e){var t=e.params.data;if(t.selected){n(s=t);var a=window.location.href;if(0<a.indexOf("?")){var o=a.substring(0,a.indexOf("?"));window.history.replaceState({},document.title,o)}}}),$.ajax({url:routeContract,type:"POST",data:{contractId:contractId},beforeSend:function(){App.showMask(!0,c)},complete:function(e,t){if(App.showMask(!1,c),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=JSON.parse(e.responseText);null==(s=a.data)?toastr.warning(a.message,"Warning"):($("#search-accomodation :input[name=contract]").next().find(".select2-selection__rendered").html(s.name+'<span class="select2-selection__placeholder"></span>'),n(s),$(".filter-content").show())}}}),$(".btn-search-submit").on("click",function(e){if(e.preventDefault(),null==s)toastr.error("Invalid contract.","Error");else{var t=moment($("input[name=from]").datepicker("getDate")).format("DD.MM.YYYY"),a=moment($("input[name=to]").datepicker("getDate")).format("DD.MM.YYYY"),o=[];$(".room-selected:checked").each(function(){o.push($(this).val())});var n=[];$(".row-selected:checked").each(function(){n.push($(this).val())}),$.ajax({url:routeData,type:"POST",data:{id:s.id,from:t,to:a,rooms:JSON.stringify(o),rows:JSON.stringify(n)},beforeSend:function(){App.showMask(!0,c)},complete:function(e,t){if(App.showMask(!1,c),"419"==e.status)location.reload(!0);else if("200"!=e.status)toastr.error("Please check your connection and try again.","Error on loading the content");else{var a=$.parseJSON(e.responseText);if("success"==a.status){var o=a.table;$(".result-container").html(""),$(".result-container").html('<div class="note note-info"><p>Pricing are all per person per night.</p></div>'),$(".result-container").append(o),a.from,a.to,$(".measure-detail").on("click",function(){var e=$(this).attr("data");$(this).hasClass("closed")?($(this).removeClass("closed"),$(this).addClass("opened"),$(this).html("-"),$('tr[data-parent="'+e+'"]').removeClass("hidden")):($(this).removeClass("opened"),$(this).addClass("closed"),$(this).html("+"),$('tr[data-parent="'+e+'"]').addClass("hidden"))}),$(".row-expanded:checked").each(function(){$('.measure-detail[data-measure="'+$(this).val()+'"]').click()})}else toastr.error(a.message,"Error")}}})}}),$(".check-all-rooms").on("click",function(e){e.preventDefault(),"check"==$(this).attr("data")?($(this).attr("data","uncheck"),$(".room-selected").each(function(){$(this).prop("checked",!1)})):($(this).attr("data","check"),$(".room-selected").each(function(){$(this).prop("checked",!0)}))})});